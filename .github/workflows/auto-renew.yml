name: GTX Gaming Server Auto Extend

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 04:00 è¿è¡Œä¸€æ¬¡ (åŒ—äº¬æ—¶é—´ä¸­åˆ 12 ç‚¹)
    # ä½ å¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´è¿™ä¸ªæ—¶é—´
    - cron: '0 4 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘ workflow

jobs:
  run-script:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      actions: write

    steps:
    - name: Check out repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x' # ä½¿ç”¨æœ€æ–°çš„ Python 3 ç‰ˆæœ¬

    - name: Install Playwright
      run: |
        pip install playwright
        playwright install chromium # å®‰è£… Chromium æµè§ˆå™¨

    - name: Run Python script
      env:
        # ç¡®ä¿åœ¨ GitHub Secrets ä¸­è®¾ç½®è¿™äº›å˜é‡
        # ç™»å½•æ–¹å¼1: Cookieç™»å½• (æ¨è)
        REMEMBER_WEB_COOKIE: ${{ secrets.REMEMBER_WEB_COOKIE }}
        # ç™»å½•æ–¹å¼2: é‚®ç®±å¯†ç ç™»å½• (å¤‡ç”¨)
        LOGIN_EMAIL: ${{ secrets.LOGIN_EMAIL }}
        LOGIN_PASSWORD: ${{ secrets.LOGIN_PASSWORD }}
        # æœåŠ¡å™¨é…ç½® - JSON æ ¼å¼ (å¿…éœ€)
        # æ ¼å¼: [{"url": "https://gamepanel2.gtxgaming.co.uk/server/xxx", "name": "æœåŠ¡å™¨åç§°"}]
        SERVER_LIST: ${{ secrets.SERVER_LIST }}
      run: python main.py

    - name: Commit and push README.md
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # æ·»åŠ READMEæ–‡ä»¶
        git add README.md
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–éœ€è¦æäº¤
        if git diff --cached --quiet; then
          echo "READMEæ–‡ä»¶æ— å˜åŒ–ï¼Œæ— éœ€æäº¤"
        else
          git commit -m "ğŸ“ æ›´æ–°è¿è¡ŒçŠ¶æ€: $(date +'%Y-%m-%d %H:%M:%S')"
          git push origin HEAD:main
        fi

    - name: Upload screenshots
      if: always()  # æ— è®ºæˆåŠŸæˆ–å¤±è´¥éƒ½ä¸Šä¼ æˆªå›¾
      uses: actions/upload-artifact@v4
      with:
        name: screenshots-${{ github.run_number }}
        path: "*.png"
        retention-days: 7
        if-no-files-found: ignore

    - name: Send Telegram notification
      if: always() && env.TELEGRAM_BOT_TOKEN != '' && env.TELEGRAM_CHAT_ID != ''
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        # ç›´æ¥ä»README.mdæå–è¿è¡Œç»“æœéƒ¨åˆ†
        if [ -f "README.md" ]; then
          # æå–è¿è¡Œç»“æœéƒ¨åˆ†ï¼ˆä»"è¿è¡Œç»“æœ:"å¼€å§‹åˆ°æ–‡ä»¶æœ«å°¾ï¼‰
          RESULT_CONTENT=$(sed -n '/\*\*è¿è¡Œç»“æœ\*\*:/,$p' README.md | tail -n +2)
          
          # å°†HTMLæ ¼å¼è½¬æ¢ä¸ºçº¯æ–‡æœ¬æ ¼å¼
          RESULT_CONTENT=$(echo "$RESULT_CONTENT" | sed 's/<br>/\n/g' | sed 's/`//g')
          
          # å¦‚æœæå–å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•
          if [ -z "$RESULT_CONTENT" ]; then
            RESULT_CONTENT="âŒ æ— æ³•æå–è¿è¡Œç»“æœ"
          fi
        else
          RESULT_CONTENT="âŒ README.mdæ–‡ä»¶ä¸å­˜åœ¨"
        fi
        
        # æ„å»ºé€šçŸ¥æ¶ˆæ¯
        MESSAGE="ğŸ•¹ï¸GTX Gamingç»­æœŸé€šçŸ¥
        ğŸ“…æ‰§è¡Œæ—¶é—´ï¼š$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')
        
        ${RESULT_CONTENT}
        
        ğŸ“‹ è¯¦ç»†ä¿¡æ¯ï¼š
        ğŸ”— [æŸ¥çœ‹è¿è¡Œæ—¥å¿—](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
        ğŸ“¸ [ä¸‹è½½æˆªå›¾](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)"
        
        # å‘é€Telegramæ¶ˆæ¯
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          -d chat_id="${TELEGRAM_CHAT_ID}" \
          -d text="${MESSAGE}" \
          -d parse_mode="Markdown"

    - name: Telegramé€šçŸ¥è·³è¿‡æç¤º
      if: always() && (env.TELEGRAM_BOT_TOKEN == '' || env.TELEGRAM_CHAT_ID == '')
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: echo "æœªé…ç½®Telegramå˜é‡ï¼Œè·³è¿‡é€šçŸ¥"

    - name: Delete old workflow runs
      uses: MajorScruffy/delete-old-workflow-runs@v0.3.0
      env:
        GITHUB_TOKEN: ${{ github.token }}
      with:
        repository: ${{ github.repository }}
        older-than-seconds: 3600  # åˆ é™¤1å°æ—¶å‰çš„è®°å½•
